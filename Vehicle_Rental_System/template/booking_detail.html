{% extends "base.html" %}
{% block title %}
    <title>Booking Details - Velo-Rent</title>
{% endblock title %}
{% block style %}
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-Completed { background-color: #dcfce7; color: #166534; }
        .status-Active { background-color: #dbeafe; color: #1e40af; }
        .status-Confirmed { background-color: #fef9c3; color: #854d0e; }
        .status-Cancelled { background-color: #fee2e2; color: #991b1b; }

        /* Star rating styles for the modal */
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* This makes the hover effect work correctly */
            justify-content: center;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 2.5rem;
            color: #d1d5db; /* gray-300 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label {
            color: #f59e0b; /* yellow-500 */
        }
        
        /* Modal styles */
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
{% endblock style %}

{% block content %}
<main class="container mx-auto px-6 py-12">
    <!-- Back Link -->
    <div class="mb-6">
        <a href="{% url 'my_profile' %}" class="text-sm font-medium text-blue-700 hover:underline">&larr; Back to My Profile</a>
    </div>

    <!-- Display Messages -->
    {% if messages %}
    <div class="max-w-4xl mx-auto mb-6">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}" role="alert">
            <span class="font-semibold">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="bg-white p-8 rounded-lg shadow-md">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-6 border-b">
            <div>
                <h2 class="text-3xl font-bold">Booking Details</h2>
                <p class="text-gray-500">Booking ID: #{{ booking.id }}</p>
            </div>
            <span class="status-badge status-{{ booking.booking_status }} mt-4 md:mt-0">
                {{ booking.booking_status }}
            </span>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Vehicle & Map -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Vehicle Info -->
                <div>
                    <h3 class="text-xl font-bold mb-4">Vehicle Information</h3>
                    <div class="flex items-center gap-6 p-4 border rounded-lg">
                        <img src="{% if booking.vehicle.vehicle_picture and booking.vehicle.vehicle_picture.url != '/media/vehicle_pics/default.jpg' %}{{ booking.vehicle.vehicle_picture.url }}{% else %}https://placehold.co/400x300/e2e8f0/cbd5e0?text={{booking.vehicle.make|urlencode}}{% endif %}"
                             alt="{{ booking.vehicle.make }} {{ booking.vehicle.model }}" class="w-40 h-28 rounded-md object-cover flex-shrink-0">
                        <div>
                            <p class="text-2xl font-bold">{{ booking.vehicle.make }} {{ booking.vehicle.model }}</p>
                            <p class="text-gray-600">{{ booking.vehicle.vehicle_number }}</p>
                            <div class="flex items-center text-sm text-gray-500 space-x-4 mt-2">
                                <span class="flex items-center gap-1.5"><i class="fa-solid fa-gas-pump w-4 text-center"></i> {{ booking.vehicle.fuel_type }}</span>
                                <span class="flex items-center gap-1.5"><i class="fa-solid fa-gears w-4 text-center"></i> {{ booking.vehicle.transmission }}</span>
                                <span class="flex items-center gap-1.5"><i class="fa-solid fa-users w-4 text-center"></i> {{ booking.vehicle.seating_capacity }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location & Map -->
                <div>
                    <h3 class="text-xl font-bold mb-4">Pickup & Return Locations</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-gray-900">Pickup Location</p>
                            <p class="text-gray-600">{{ booking.pickup_location }}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="font-semibold text-gray-900">Return Location</p>
                            <p class="text-gray-600">{{ booking.return_location }}</p>
                        </div>
                    </div>
                    <!-- Placeholder for a map -->
                    <div class="w-full h-64 bg-gray-200 rounded-lg mt-4 flex items-center justify-center">
                        <p class="text-gray-500">Map placeholder for locations</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Date & Time Summary -->
                <div class="p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-bold mb-4">Rental Period</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Pickup Time</p>
                            <p class="text-lg font-medium text-gray-900">{{ booking.pickup_datetime|date:"M d, Y, P" }}</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Return Time</p>
                            <p class="text-lg font-medium text-gray-900">{{ booking.return_datetime|date:"M d, Y, P" }}</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Total Duration</p>
                            <p class="text-lg font-medium text-gray-900">{{ booking.total_hours|floatformat:1 }} hours</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="p-6 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4">Payment Summary</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Hourly Rate</span>
                            <span class="font-medium text-gray-900">₹{{ booking.hourly_rate|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Duration ({{ booking.total_hours|floatformat:1 }} hrs)</span>
                            <span class="font-medium text-gray-900">₹{{ booking.total_amount|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Security Deposit</span>
                            <span class="font-medium text-gray-900">₹{{ booking.security_deposit|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between pt-3 border-t text-base">
                            <span class="font-bold text-gray-900">Grand Total</span>
                            <span class="font-bold text-blue-600 text-lg">₹{{ grand_total|floatformat:2 }}</span>
                        </div>
                    </div>
                    <!-- Payment List -->
                    <div class="mt-4">
                        <h4 class="text-md font-semibold mb-2">Payment Status</h4>
                        {% for payment in booking_payments %}
                            <div class="flex justify-between items-center text-sm p-2 bg-white rounded border">
                                <div>
                                    <p class="font-medium">{{ payment.get_payment_type_display }}</p>
                                    <p class="text-xs text-gray-500">{{ payment.get_payment_method_display }}</p>
                                </div>
                                <span class="font-semibold text-green-700">{{ payment.get_payment_status_display }}</span>
                            </div>
                        {% empty %}
                            <p class="text-sm text-center text-gray-500 p-2 bg-white rounded border">No payment records found.</p>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Review Summary -->
                <div class="p-6 bg-gray-50 rounded-lg border">
                    <h3 class="text-xl font-bold mb-4">Your Review</h3>
                    {% if booking_review %}
                        <!-- Display existing review -->
                        <div class="flex items-center mb-2">
                            {% for i in "12345" %}
                                <i class="fa-solid fa-star {% if forloop.counter <= booking_review.rating %}text-yellow-400{% else %}text-gray-300{% endif %}"></i>
                            {% endfor %}
                        </div>
                        <p class="text-gray-600 italic mb-4">"{{ booking_review.review_text }}"</p>
                        <div class="flex gap-2">
                            <button id="edit-review-btn" class="w-full py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                                Edit Review
                            </button>
                            <button id="delete-review-btn" class="w-full py-2 px-4 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    {% else %}
                        <!-- Show "Leave Review" button -->
                        <p class="text-sm text-center text-gray-500">You have not left a review for this booking yet.</p>
                        {% if booking.booking_status == 'Completed' %}
                            <button id="add-review-btn" class="w-full mt-4 py-2 px-4 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                                Leave a Review
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modals are placed here, inside the main block but outside the layout grid -->

    <!-- Add/Edit Review Modal -->
    <div id="review-modal" class="fixed inset-0 z-[60] hidden items-center justify-center">
        <div id="review-modal-backdrop" class="absolute inset-0 bg-black/60 modal-backdrop opacity-0"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 modal-content transform scale-95">
            <form id="review-form" method="POST" action="">
                {% csrf_token %}
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 id="review-modal-title" class="text-2xl font-bold">Leave a Review</h2>
                    <button type="button" id="close-review-modal-btn" class="text-gray-400 hover:text-gray-700">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-center text-sm font-medium text-gray-700 mb-2">Select Your Rating</label>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5" {% if booking_review.rating == 5 %}checked{% endif %}><label for="star5" title="5 stars">&#9733;</label>
                            <input type="radio" id="star4" name="rating" value="4" {% if booking_review.rating == 4 %}checked{% endif %}><label for="star4" title="4 stars">&#9733;</label>
                            <input type="radio" id="star3" name="rating" value="3" {% if booking_review.rating == 3 %}checked{% endif %}><label for="star3" title="3 stars">&#9733;</label>
                            <input type="radio" id="star2" name="rating" value="2" {% if booking_review.rating == 2 %}checked{% endif %}><label for="star2" title="2 stars">&#9733;</label>
                            <input type="radio" id="star1" name="rating" value="1" {% if booking_review.rating == 1 %}checked{% endif %}><label for="star1" title="1 star">&#9733;</label>
                        </div>
                    </div>
                    <div>
                        <label for="review_text" class="block text-sm font-medium text-gray-700">Your Review</label>
                        <textarea id="review_text" name="review_text" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us about your experience...">{{ booking_review.review_text|default:'' }}</textarea>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end">
                    <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                        Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Review Modal -->
    <div id="delete-modal" class="fixed inset-0 z-[60] hidden items-center justify-center">
        <div id="delete-modal-backdrop" class="absolute inset-0 bg-black/60 modal-backdrop opacity-0"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-md m-4 modal-content transform scale-95">
            <!-- This form action is set correctly *if* the review exists -->
            <form id="delete-form" method="POST" action="{% if booking_review %}{% url 'delete_review' booking_review.id %}{% endif %}">
                {% csrf_token %}
                <div class="p-6">
                    <div class="text-center">
                        <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold">Delete Review?</h2>
                        <p class="text-gray-500 mt-2">Are you sure you want to delete this review? This action cannot be undone.</p>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end gap-4">
                    <button type="button" id="close-delete-modal-btn" class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Review Modal ---
    const reviewModal = document.getElementById('review-modal');
    if (reviewModal) {
        const backdrop = document.getElementById('review-modal-backdrop');
        const modalContent = reviewModal.querySelector('.modal-content');
        const closeBtn = document.getElementById('close-review-modal-btn');
        const addBtn = document.getElementById('add-review-btn');
        const editBtn = document.getElementById('edit-review-btn');
        const reviewForm = document.getElementById('review-form');
        const reviewModalTitle = document.getElementById('review-modal-title');
        
        const openReviewModal = () => {
            reviewModal.classList.remove('hidden');
            reviewModal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        };
        
        const closeReviewModal = () => {
            backdrop.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                reviewModal.classList.add('hidden');
                reviewModal.classList.remove('flex');
            }, 300);
        };

        // This button only exists if there is NO review
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                reviewModalTitle.textContent = 'Leave a Review';
                // This URL is for ADDING a review
                reviewForm.action = "{% url 'add_review' booking.id %}";
                openReviewModal();
            });
        }
        
        // This button only exists if there IS a review
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        reviewModalTitle.textContent = 'Edit Your Review';
                        // Set the form action only when booking_review exists server-side to avoid reverse errors
                        {% if booking_review %}
                            reviewForm.action = "{% url 'edit_review' booking_review.id %}";
                        {% else %}
                            // Fallback: no action if there's no valid review id
                            reviewForm.action = "";
                        {% endif %}
                        openReviewModal();
                    });
                }
        
        closeBtn.addEventListener('click', closeReviewModal);
        backdrop.addEventListener('click', closeReviewModal);
    }
    
    // --- Delete Modal ---
    const deleteModal = document.getElementById('delete-modal');
    if (deleteModal) {
        const backdrop = document.getElementById('delete-modal-backdrop');
        const modalContent = deleteModal.querySelector('.modal-content');
        const openBtn = document.getElementById('delete-review-btn');
        const closeBtn = document.getElementById('close-delete-modal-btn');
        
        const openDeleteModal = () => {
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        };
        
        const closeDeleteModal = () => {
            backdrop.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
            }, 300);
        };
        
        // This button only exists if there IS a review
        if (openBtn) {
            openBtn.addEventListener('click', openDeleteModal);
        }
        closeBtn.addEventListener('click', closeDeleteModal);
        backdrop.addEventListener('click', closeDeleteModal);
    }
});
</script>
{% endblock scripts %}