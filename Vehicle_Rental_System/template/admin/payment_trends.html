{% extends "admin/bases.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Payment Trends Analysis</h2>
</div>

<form method="get" class="card card-body mb-4">
    <div class="row">
        <div class="col-md-4">
            <label>Start Date</label>
            <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-4">
            <label>End Date</label>
            <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
        </div>
        <div class="col-md-4">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary btn-block">Generate Report</button>
        </div>
    </div>
</form>

{% if trends_data %}
<div class="card">
    <div class="card-body">
        <h5 class="card-title">Payment Trends by Month</h5>
        <canvas id="trendsChart"></canvas>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">Detailed Data</h5>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Payment Method</th>
                        <th>Transactions</th>
                        <th>Total Amount (₹)</th>
                        <th>Average Amount (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month, methods in trends_data.items %}
                        {% for method, data in methods.items %}
                        <tr>
                            <td>{{ month }}</td>
                            <td>{{ method }}</td>
                            <td>{{ data.count }}</td>
                            <td>₹{{ data.total|floatformat:2 }}</td>
                            <td>₹{{ data.avg|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">No payment trend data available for the selected period.</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if trends_data %}
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    // Prepare data from Django context
    const trendsData = {{ trends_data|safe }};
    const months = Object.keys(trendsData);
    const methods = [...new Set(Object.values(trendsData).flatMap(m => Object.keys(m)))];
    
    // Create datasets for each payment method
    const datasets = methods.map((method, index) => {
        const color = `hsl(${index * 60}, 70%, 50%)`;
        return {
            label: method,
            data: months.map(month => trendsData[month][method] ? trendsData[month][method].total : 0),
            backgroundColor: color,
            borderColor: color,
            borderWidth: 2,
            fill: false
        };
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue (₹)'
                    }
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}