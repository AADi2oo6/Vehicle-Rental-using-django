{% extends "base.html" %}

{% block title %}
<title>Confirm Your Booking - Velo-Rent</title>
{% endblock title %}

{% block style %}
    <!-- ... (existing styles) ... -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        #fare-details {
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #fare-details.visible {
            max-height: 300px;
            opacity: 1;
        }
        /* Styles for the new modal */
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
{% endblock style %}

{% block content %}
<main class="container mx-auto px-6 py-12">

    

    <h1 class="text-3xl font-bold mb-8 text-center">Confirm Your Booking</h1>
        
        <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Vehicle Details -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4">{{ vehicle.make }} {{ vehicle.model }}</h2>
                <img src="{% if vehicle.vehicle_picture and vehicle.vehicle_picture.url != '/media/vehicle_pics/default.jpg' %}{{ vehicle.vehicle_picture.url }}{% else %}https://placehold.co/600x400/e2e8f0/cbd5e0?text={{vehicle.make|urlencode}}{% endif %}" alt="{{ vehicle.make }} {{ vehicle.model }}" class="w-full h-64 object-cover rounded-lg mb-6">
                
                <div class="space-y-3 text-gray-600">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Hourly Rate:</span>
                        <span class="text-lg font-bold text-blue-600">₹{{ vehicle.hourly_rate|floatformat:0 }}/hr</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Type:</span>
                        <span>{{ vehicle.vehicle_type }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Fuel:</span>
                        <span>{{ vehicle.fuel_type }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Transmission:</span>
                        <span>{{ vehicle.transmission }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Seats:</span>
                        <span>{{ vehicle.seating_capacity }}</span>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6">Booking Details</h2>
                
                <!-- This form now submits to the *same view* to show the modal -->
                <form method="POST" action="{% url 'booking' vehicle.id %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="pickup_datetime" class="block text-sm font-medium text-gray-700 mb-1">Pickup Date & Time</label>
                            <!-- 
                                FIXED: This value now safely checks if form_data exists first, 
                                then falls back to values, then to an empty string. 
                            -->
                            <input type="datetime-local" name="pickup_datetime" id="pickup_datetime" value="{% if form_data %}{{ form_data.pickup_datetime }}{% else %}{{ values.pickup_datetime|default:'' }}{% endif %}" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="return_datetime" class="block text-sm font-medium text-gray-700 mb-1">Return Date & Time</label>
                            <!-- FIXED: Applied same logic here -->
                            <input type="datetime-local" name="return_datetime" id="return_datetime" value="{% if form_data %}{{ form_data.return_datetime }}{% else %}{{ values.return_datetime|default:'' }}{% endif %}" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="pickup_location" class="block text-sm font-medium text-gray-700 mb-1">Pickup Location</label>
                            <!-- FIXED: Applied same logic here, falling back to values.location -->
                            <input type="text" name="pickup_location" id="pickup_location" value="{% if form_data %}{{ form_data.pickup_location }}{% else %}{{ values.location|default:'' }}{% endif %}" placeholder="e.g., Pune Airport" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="return_location" class="block text-sm font-medium text-gray-700 mb-1">Return Location</label>
                            <!-- FIXED: Applied same logic here, falling back to values.location -->
                            <input type="text" name="return_location" id="return_location" value="{% if form_data %}{{ form_data.return_location }}{% else %}{{ values.location|default:'' }}{% endif %}" placeholder="e.g., Pune Airport" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="pt-2">
                            <button type="button" id="calculate-fare-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition duration-300">
                                Calculate Fare
                            </button>
                        </div>

                        <div id="fare-details" class="border-t pt-4 space-y-3">
                            <div class="flex justify-between items-center text-gray-600">
                                <span class="font-semibold">Total Hours:</span>
                                <span id="total-hours" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center text-gray-800">
                                <span class="font-semibold text-lg">Estimated Fare:</span>
                                <span id="estimated-fare" class="font-bold text-xl text-blue-600">₹--</span>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <!-- This button now SUBMITS THE FORM to show the modal -->
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                                Confirm & Book
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- NEW: Payment Confirmation Modal -->
    <!-- This is shown only if the view validates the data and sets 'show_payment_modal' to True -->
    {% if show_payment_modal %}
    <div id="payment-modal" class="fixed inset-0 z-[60] flex items-center justify-center">
        <div id="payment-modal-backdrop" class="absolute inset-0 bg-black/60 modal-backdrop opacity-100"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 modal-content transform scale-100">
            
            <!-- This new form posts to the 'confirm_booking_pay_later' view -->
            <form method="POST" action="{% url 'confirm_booking_pay_later' vehicle.id %}">
                {% csrf_token %}
                <!-- Hidden fields to pass all the validated booking data -->
                <input type="hidden" name="pickup_datetime" value="{{ form_data.pickup_datetime }}">
                <input type="hidden" name="return_datetime" value="{{ form_data.return_datetime }}">
                <input type="hidden" name="pickup_location" value="{{ form_data.pickup_location }}">
                <input type="hidden" name="return_location" value="{{ form_data.return_location }}">
                <input type="hidden" name="total_amount" value="{{ total_amount }}">
                <input type="hidden" name="security_deposit_amount" value="{{ security_deposit_amount }}">

                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold">Confirm Your Payment</h2>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-gray-600">Your booking is almost complete. Please select a payment option.</p>
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-700">Estimated Fare:</span>
                            <span class="font-bold text-lg">₹{{ total_amount }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Security Deposit (20%):</span>
                            <span class="font-bold text-lg">₹{{ security_deposit_amount }}</span>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="w-full py-3 px-5 text-left bg-gray-200 text-gray-500 rounded-lg cursor-not-allowed" disabled>
                            <span class="font-bold">Pay ₹{{ security_deposit_amount }} Now</span>
                            <span class="block text-sm">Online payment gateway (Coming Soon)</span>
                        </button>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 rounded-b-xl flex justify-between items-center">
                    <a href="{% url 'booking' vehicle.id %}" class="text-sm font-medium text-gray-600 hover:underline">Cancel</a>
                    <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                        Book and Pay Later
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}


    <div id="booking-data" data-hourly-rate="{{ vehicle.hourly_rate }}"></div>
    
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pickupInput = document.getElementById('pickup_datetime');
    const returnInput = document.getElementById('return_datetime');
    const calculateBtn = document.getElementById('calculate-fare-btn');
    const fareDetails = document.getElementById('fare-details');
    const totalHoursSpan = document.getElementById('total-hours');
    const estimatedFareSpan = document.getElementById('estimated-fare');
    const bookingData = document.getElementById('booking-data');
    const hourlyRate = parseFloat(bookingData.dataset.hourlyRate);

    const formatDateTimeLocal = (date) => {
        const pad = (n) => n.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    const now = new Date();
    // Ensure pickupInput exists before setting min
    if (pickupInput) {
        pickupInput.min = formatDateTimeLocal(now);

        // Set default times only if the fields are not already filled
        if (!pickupInput.value) {
            const defaultPickupTime = new Date(now.getTime() + 60 * 60 * 1000);
            pickupInput.value = formatDateTimeLocal(defaultPickupTime);
        }
    }

    if (returnInput && !returnInput.value) {
        // Ensure pickupInput.value is valid before creating a Date from it
        const pickupDateVal = pickupInput ? pickupInput.value : now;
        const defaultReturnTime = new Date(new Date(pickupDateVal).getTime() + 4 * 60 * 60 * 1000);
        returnInput.value = formatDateTimeLocal(defaultReturnTime);
    }
    
    if (pickupInput && returnInput) {
        returnInput.min = pickupInput.value;
        pickupInput.addEventListener('change', () => {
            const pickupDate = new Date(pickupInput.value);
            returnInput.min = formatDateTimeLocal(pickupDate);
            if (new Date(returnInput.value) <= pickupDate) {
                const newReturnDate = new Date(pickupDate.getTime() + 4 * 60 * 60 * 1000);
                returnInput.value = formatDateTimeLocal(newReturnDate);
            }
        });
    }

    if (calculateBtn) {
        calculateBtn.addEventListener('click', () => {
            const pickupDate = new Date(pickupInput.value);
            const returnDate = new Date(returnInput.value);

            if (isNaN(pickupDate) || isNaN(returnDate) || returnDate <= pickupDate) {
                // We agreed not to use alert(). Let's use a non-blocking message.
                // For now, we'll just log to console and prevent calculation.
                console.error("Invalid pickup or return date.");
                // You could also display this error message in the 'fare-details' section
                return;
            }

            const diffMilliseconds = returnDate - pickupDate;
            const diffHours = diffMilliseconds / (1000 * 60 * 60);
            const totalFare = diffHours * hourlyRate;

            totalHoursSpan.textContent = diffHours.toFixed(1);
            estimatedFareSpan.textContent = `₹${totalFare.toFixed(0)}`;
            fareDetails.classList.add('visible');
        });
    }
});
</script>
{% endblock scripts %}