{% extends "base.html" %}

{% block title %}
<title>Confirm Your Booking - Velo-Rent</title>
{% endblock title %}

{% block style %}
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        #fare-details {
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #fare-details.visible {
            max-height: 300px;
            opacity: 1;
        }
    </style>
{% endblock style %}

{% block content %}
<main class="container mx-auto px-6 py-12">

    <!-- NEW: Django Messages Block -->
    {% if messages %}
    <div class="max-w-5xl mx-auto mb-8">
        {% for message in messages %}
        <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}" role="alert">
            <span class="font-semibold">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <h1 class="text-3xl font-bold mb-8 text-center">Confirm Your Booking</h1>
        
        <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Vehicle Details -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4">{{ vehicle.make }} {{ vehicle.model }}</h2>
                <img src="{% if vehicle.vehicle_picture and vehicle.vehicle_picture.url != '/media/vehicle_pics/default.jpg' %}{{ vehicle.vehicle_picture.url }}{% else %}https://placehold.co/600x400/e2e8f0/cbd5e0?text={{vehicle.make|urlencode}}{% endif %}" alt="{{ vehicle.make }} {{ vehicle.model }}" class="w-full h-64 object-cover rounded-lg mb-6">
                
                <div class="space-y-3 text-gray-600">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Hourly Rate:</span>
                        <span class="text-lg font-bold text-blue-600">₹{{ vehicle.hourly_rate|floatformat:0 }}/hr</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Type:</span>
                        <span>{{ vehicle.vehicle_type }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Fuel:</span>
                        <span>{{ vehicle.fuel_type }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Transmission:</span>
                        <span>{{ vehicle.transmission }}</span>
                    </div>
                    <div class="flex justify-between items-center border-t pt-3">
                        <span class="font-semibold">Seats:</span>
                        <span>{{ vehicle.seating_capacity }}</span>
                    </div>
                </div>
            </div>

            <!-- Booking Form -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6">Booking Details</h2>
                <form method="POST" action="{% url 'booking' vehicle.id %}">
                    {% csrf_token %}
                    <div class="space-y-6">
                        <div>
                            <label for="pickup_datetime" class="block text-sm font-medium text-gray-700 mb-1">Pickup Date & Time</label>
                            <input type="datetime-local" name="pickup_datetime" id="pickup_datetime" value="{{ values.pickup_datetime }}" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="return_datetime" class="block text-sm font-medium text-gray-700 mb-1">Return Date & Time</label>
                            <input type="datetime-local" name="return_datetime" id="return_datetime" value="{{ values.return_datetime }}" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="pickup_location" class="block text-sm font-medium text-gray-700 mb-1">Pickup Location</label>
                            <input type="text" name="pickup_location" id="pickup_location" value="{{ values.location }}" placeholder="e.g., Pune Airport" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="return_location" class="block text-sm font-medium text-gray-700 mb-1">Return Location</label>
                            <input type="text" name="return_location" id="return_location" value="{{ values.location }}" placeholder="e.g., Pune Airport" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="pt-2">
                            <button type="button" id="calculate-fare-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-lg hover:bg-gray-300 transition duration-300">
                                Calculate Fare
                            </button>
                        </div>

                        <div id="fare-details" class="border-t pt-4 space-y-3">
                            <div class="flex justify-between items-center text-gray-600">
                                <span class="font-semibold">Total Hours:</span>
                                <span id="total-hours" class="font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center text-gray-800">
                                <span class="font-semibold text-lg">Estimated Fare:</span>
                                <span id="estimated-fare" class="font-bold text-xl text-blue-600">₹--</span>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                                Confirm & Book
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="booking-data" data-hourly-rate="{{ vehicle.hourly_rate }}"></div>
    
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pickupInput = document.getElementById('pickup_datetime');
    const returnInput = document.getElementById('return_datetime');
    const calculateBtn = document.getElementById('calculate-fare-btn');
    const fareDetails = document.getElementById('fare-details');
    const totalHoursSpan = document.getElementById('total-hours');
    const estimatedFareSpan = document.getElementById('estimated-fare');
    const bookingData = document.getElementById('booking-data');
    const hourlyRate = parseFloat(bookingData.dataset.hourlyRate);

    const formatDateTimeLocal = (date) => {
        const pad = (n) => n.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    const now = new Date();
    pickupInput.min = formatDateTimeLocal(now);

    if (!pickupInput.value) {
        const defaultPickupTime = new Date(now.getTime() + 60 * 60 * 1000);
        pickupInput.value = formatDateTimeLocal(defaultPickupTime);
    }

    if (!returnInput.value) {
        const defaultReturnTime = new Date(new Date(pickupInput.value).getTime() + 4 * 60 * 60 * 1000);
        returnInput.value = formatDateTimeLocal(defaultReturnTime);
    }
    returnInput.min = pickupInput.value;

    pickupInput.addEventListener('change', () => {
        const pickupDate = new Date(pickupInput.value);
        returnInput.min = formatDateTimeLocal(pickupDate);
        if (new Date(returnInput.value) <= pickupDate) {
            const newReturnDate = new Date(pickupDate.getTime() + 4 * 60 * 60 * 1000);
            returnInput.value = formatDateTimeLocal(newReturnDate);
        }
    });

    calculateBtn.addEventListener('click', () => {
        const pickupDate = new Date(pickupInput.value);
        const returnDate = new Date(returnInput.value);

        if (isNaN(pickupDate) || isNaN(returnDate) || returnDate <= pickupDate) {
            alert("Please select a valid pickup and return date. The return date must be after the pickup date.");
            return;
        }

        const diffMilliseconds = returnDate - pickupDate;
        const diffHours = diffMilliseconds / (1000 * 60 * 60);
        const totalFare = diffHours * hourlyRate;

        totalHoursSpan.textContent = diffHours.toFixed(1);
        estimatedFareSpan.textContent = `₹${totalFare.toFixed(0)}`;
        fareDetails.classList.add('visible');
    });
});
</script>
{% endblock scripts %}

